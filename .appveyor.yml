image: Visual Studio 2019

clone_script:
- ps: >-
    if(-not $env:APPVEYOR_PULL_REQUEST_NUMBER) {
      git clone -q --branch=$env:APPVEYOR_REPO_BRANCH https://github.com/$env:APPVEYOR_REPO_NAME.git $env:APPVEYOR_BUILD_FOLDER
      cd $env:APPVEYOR_BUILD_FOLDER
      git checkout -qf $env:APPVEYOR_REPO_COMMIT
    } else {
      git clone -q https://github.com/$env:APPVEYOR_REPO_NAME.git $env:APPVEYOR_BUILD_FOLDER
      cd $env:APPVEYOR_BUILD_FOLDER
      git fetch -q origin +refs/pull/$env:APPVEYOR_PULL_REQUEST_NUMBER/merge:
      git checkout -qf FETCH_HEAD
    }
- cmd: git submodule update --init --recursive

platform:
  - x64

configuration:
  - Debug
  - Release

matrix:
  fast_finish: false

only_commits:
  files:
    - src/
    - vc14/
    - .appveyor.yml

install:
  - cmd : vcpkg install boost-asio:x64-windows
  - cmd : vcpkg install boost-filesystem:x64-windows
  - cmd : vcpkg install boost-iostreams:x64-windows
  - cmd : vcpkg install boost-lockfree:x64-windows
  - cmd : vcpkg install boost-system:x64-windows
  - cmd : vcpkg install boost-variant:x64-windows
  - cmd : vcpkg install lua:x64-windows
  - cmd : vcpkg install mpir:x64-windows

build:
  parallel: true
  project: vc14/canary-server.sln
  # MSBuild verbosity level
  # verbosity: detailed

# scripts to run after build (working directory and environment changes are persisted from the previous steps)
after_build:
  - 7z a -tzip canary-server.zip -r .\vc14\*.exe -ir!.\vc14\*.dll

cache:
  - c:\tools\vcpkg\installed\

artifacts:
  - path: vc14\**\canary-server*.exe
  - path: vc14\**\*.dll
  - path: canary-server.zip
